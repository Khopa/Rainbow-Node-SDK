<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" /> 
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Frame</title>
		<script src="//cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/es6-promise/4.0.5/es6-promise.min.js"></script>
        <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
        <script src="//cdn.jsdelivr.net/momentjs/2.15.1/moment-with-locales.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.7/angular.min.js"></script>
        
         <!-- Test SDK build dir -->
        <script src="../bin/lib/vendors-sdk.min.js"></script>
        <script src="../bin/lib/rainbow-sdk.min.js"></script>
	</head>

    <body>
        <video id="minivideo" autoplay muted></video>
        <video id="largevideo" autoplay></video>
        <video id="globalVideoTag" autoplay style="display:none;"></video>
        <audio id="globalAudioTag" autoplay style="display:none;"></audio>

        <script>
            $(function() {

                var that = this;

                var identity = window.frameElement.id;

                var eventToListen = "";
                var propToRetrieve = "";

                var eventHandler = function eventHandler(__event, data) {
                    console.log("[TST-FRAME][" + identity + "] :: Event received " + eventToListen);
                    console.log("[TST-FRAME][" + identity + "] :: Data received", data);
                    
                    var val = null;
                    try {
                        if(propToRetrieve.length > 0) {
                            val = eval("data." + propToRetrieve);
                            console.log("[TST-FRAME][" + identity + "] :: Get value=" + val + " for prop=" + propToRetrieve);
                        }
                        else {
                            console.log("[TST-FRAME][" + identity + "] :: No property to retrieve");
                        }
                    }
                    catch(err) {
                        console.log("[TST-FRAME][" + identity + "] --> Error in eval for " + propToRetrieve);
                    }
                    window.parent.postMessage({id: identity, evt: "listenResponse", propValue: val}, "*");
                    $(document).off(eventToListen);
                };

                var listenToEvent = function listenToEvent(event, prop) {
                    console.log("[TST-FRAME][" + identity + "] :: Ask to listen to event " + event);
                    eventToListen = event;
                    propToRetrieve = prop;
                    $(document).on(eventToListen, eventHandler);
                };

                window.addEventListener("message", function(event) {
                    var json = event.data;
                    
                    switch(json.evt) {
                        case "listen":
                            listenToEvent(json.listening, json.prop);
                            break;
                        default:
                            break;
                    }
                }, false);

                /* Bootstrap the SDK */
                angular.bootstrap(document, ["sdk"]).get("rainbowSDK");

                var onReady = function onReady() {
                    console.log("[TST-FRAME][" + identity + "] :: On SDK Ready !");
                };

                var onLoaded = function onLoaded() {
                    console.log("[TST-FRAME][" + identity + "] :: On SDK Loaded !");

                    rainbowSDK.initialize()
                    .then( ()=> {
                        console.log("[TST-FRAME][" + identity + "] :: Ready ! alert parent...");
                        window.parent.postMessage({id: identity, evt: "started"}, "*");
                    }).catch( (err) => {
                        console.log("[TST-FRAME][" + identity + "] :: Error", err);
                    });
                };

                /* Listen to the SDK event RAINBOW_ONREADY */
                $(document).on(rainbowSDK.RAINBOW_ONREADY, onReady);

                /* Listen to the SDK event RAINBOW_ONLOADED */
                $(document).on(rainbowSDK.RAINBOW_ONLOADED, onLoaded);

                rainbowSDK.load();
            });
        </script>
    </body>

</html>