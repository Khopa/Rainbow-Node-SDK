{
    "describe": "IM API", 
    "starring": {
        "admin": {
            "robert": {
                "email": "rford@westworld.com",
                "password": "Password_123"
            }
        },
        "actors": {
            "charlotte": {
                "email": "chale@guest-westworld.com",
                "firstname": "Charlotte",
                "lastname": "Hale",
                "company": "Westworld Guest",
                "password": "Password_123"
            },
            "lee": {
                "email": "lsizemore@guest-westworld.com",
                "firstname": "Lee",
                "lastname": "Sizemore",
                "company": "Westworld Guest",
                "password": "Password_123"
            }
        }
    },
    "runBeforeAll": {
        "it": {
            "should": "Log-in with Charlotte and Lee successfully",
            "by": [
                {
                    "executing": "api:connection.signin", 
                    "injecting": ["usr:@.email", "usr:@.password"], 
                    "resulting": "account", 
                    "expecting": [{"var:account": "$defined"}],
                    "using": ["charlotte", "lee"]
                }
            ]
        }
    },   
    "runAfterAll": {
        "it": {
            "should": "Log-out with Charlotte and Lee successfully",
            "by": [
                {
                    "executing": "api:connection.signout", 
                    "injecting": [], 
                    "resulting": null, 
                    "expecting": [],
                    "using": ["charlotte", "lee"]
                }
            ]
        }
    },
    "run": [
        {
            "it": {
                "should": "Remove all messages from the conversation between Charlotte and Lee",
                "by": [
                    {
                        "executing": "api:contacts.searchByLogin", 
                        "injecting": ["usr:charlotte.email"], 
                        "resulting": "charlotteContact", 
                        "expecting": [{"var:charlotteContact.loginEmail": "#chale@guest-westworld.com"}],
                        "using": ["lee"]
                    },
                    {
                        "executing": "api:conversations.openConversationForContact", 
                        "injecting": ["var:charlotteContact"], 
                        "resulting": "conversationWithCharlotte", 
                        "expecting": [{"var:conversationWithCharlotte": "$defined"}],
                        "using": ["lee"]
                    },
                    {
                        "executing": "api:im.removeAllMessagesFromConversation", 
                        "injecting": ["var:conversationWithCharlotte"], 
                        "resulting": "updatedConversationWithCharlotte", 
                        "expecting": [{"var:updatedConversationWithCharlotte": "$defined"}],
                        "using": ["lee"]
                    },
                    {
                        "executing": "api:im.getMessagesFromConversation", 
                        "injecting": ["var:conversationWithCharlotte"], 
                        "resulting": "emptyConversationWithCharlotte", 
                        "expecting": [{"var:emptyConversationWithCharlotte": "$defined"}, {"var:emptyConversationWithCharlotte.messages.length": 0}],
                        "using": ["lee"]
                    },
                    {
                        "executing": "api:contacts.searchByLogin", 
                        "injecting": ["usr:lee.email"], 
                        "resulting": "leeContact", 
                        "expecting": [{"var:leeContact.loginEmail": "#lsizemore@guest-westworld.com"}],
                        "using": ["charlotte"]
                    },
                    {
                        "executing": "api:conversations.openConversationForContact", 
                        "injecting": ["var:leeContact"], 
                        "resulting": "conversationWithLee", 
                        "expecting": [{"var:conversationWithLee": "$defined"}],
                        "using": ["charlotte"]
                    },
                    {
                        "executing": "api:im.removeAllMessagesFromConversation", 
                        "injecting": ["var:conversationWithLee"], 
                        "resulting": "updatedConversationWithLee", 
                        "expecting": [{"var:updatedConversationWithLee": "$defined"}],
                        "using": ["charlotte"]
                    },
                    {
                        "executing": "api:im.getMessagesFromConversation", 
                        "injecting": ["var:conversationWithLee"], 
                        "resulting": "emptyConversationWithLee", 
                        "expecting": [{"var:emptyConversationWithLee": "$defined"}, {"var:emptyConversationWithLee.messages.length": 0}],
                        "using": ["charlotte"]
                    }
                ]
            }
        },
        {
            "it": {
                "should": "Send a message from Lee to Charlotte and wait until Charlotte receives it, checks that the message content and receipt status are correct, marks it as read and finally check that Lee is notified",
                "by": [
                    {
                        "executing": "api:contacts.searchByLogin", 
                        "injecting": ["usr:charlotte.email"], 
                        "resulting": "charlotteContact", 
                        "expecting": [{"var:charlotteContact.loginEmail": "#chale@guest-westworld.com"}],
                        "using": ["lee"]
                    },
                    {
                        "executing": "api:conversations.openConversationForContact", 
                        "injecting": ["var:charlotteContact"], 
                        "resulting": "conversationWithCharlotte", 
                        "expecting": [{"var:conversationWithCharlotte": "$defined"}],
                        "using": ["lee"]
                    },
                    {
                        "executing": "api:im.sendMessageToConversation", 
                        "injecting": ["var:conversationWithCharlotte", "Hello Charlotte!"],
                        "waiting": {
                            "forEvent": "api:conversations.RAINBOW_ONCONVERSATIONSCHANGED",
                            "resulting": "conversation>id",
                            "using": ["charlotte"]
                        }, 
                        "resulting": "messageSent", 
                        "expecting": [{"var:messageSent": "$defined"}],
                        "using": ["lee"]
                    },
                    {
                        "executing": "api:conversations.getConversationById", 
                        "injecting": ["var:conversation.id"], 
                        "resulting": "conversationWithLee", 
                        "expecting": [{"var:conversation": "$defined"}, {"var:conversationWithLee.messages.length": 1}, {"var:conversationWithLee.messages[0].data": "Hello Charlotte!"}, {"var:conversationWithLee.messages[0].receiptStatus": 4}],
                        "using": ["charlotte"]
                    },
                    {
                        "executing": "api:im.markMessageFromConversationAsRead", 
                        "injecting": ["var:conversationWithLee", "var:conversationWithLee.messages[0]"],
                        "waiting": {
                            "forEvent": "api:conversations.RAINBOW_ONCONVERSATIONSCHANGED",
                            "resulting": "conversation>id",
                            "using": ["lee"]
                        }, 
                        "resulting": "messageAcknowledged", 
                        "expecting": [{"var:conversationWithCharlotte.messages[0].receiptStatus": 5, "for": "lee"}],
                        "using": ["charlotte"]
                    },
                    {
                        "executing": "api:im.removeAllMessagesFromConversation", 
                        "injecting": ["var:conversationWithCharlotte"], 
                        "resulting": "updatedConversationWithCharlotte", 
                        "expecting": [{"var:updatedConversationWithCharlotte": "$defined"}],
                        "using": ["lee"]
                    },
                    {
                        "executing": "api:im.getMessagesFromConversation", 
                        "injecting": ["var:conversationWithCharlotte"], 
                        "resulting": "emptyConversationWithCharlotte", 
                        "expecting": [{"var:emptyConversationWithCharlotte": "$defined"}, {"var:emptyConversationWithCharlotte.messages.length": 0}],
                        "using": ["lee"]
                    },
                    {
                        "executing": "api:im.removeAllMessagesFromConversation", 
                        "injecting": ["var:conversationWithLee"], 
                        "resulting": "updatedConversationWithLee", 
                        "expecting": [{"var:updatedConversationWithLee": "$defined"}],
                        "using": ["charlotte"]
                    },
                    {
                        "executing": "api:im.getMessagesFromConversation", 
                        "injecting": ["var:conversationWithLee"], 
                        "resulting": "emptyConversationWithLee", 
                        "expecting": [{"var:emptyConversationWithLee": "$defined"}, {"var:emptyConversationWithLee.messages.length": 0}],
                        "using": ["charlotte"]
                    },
                    {
                        "executing": "api:conversations.closeConversation", 
                        "injecting": ["var:conversationWithLee"],
                        "waiting": {
                            "forEvent": "api:conversations.RAINBOW_ONCONVERSATIONREMOVED",
                            "resulting": "conversation>dbId",
                            "using": ["charlotte"]
                        },
                        "resulting": "", 
                        "expecting": [],
                        "using": ["charlotte"]
                    },
                    {
                        "executing": "api:conversations.closeConversation", 
                        "injecting": ["var:conversationWithCharlotte"],
                        "waiting": {
                            "forEvent": "api:conversations.RAINBOW_ONCONVERSATIONREMOVED",
                            "resulting": "conversation>dbId",
                            "using": ["lee"]
                        },
                        "resulting": "", 
                        "expecting": [],
                        "using": ["lee"]
                    }
                ]
            }
        }
    ]
}